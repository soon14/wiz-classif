


这是一个系列文章，目前包含：

《支付山河图》卷零——总论【当前文章】
《支付山河图》卷二——退款篇
《支付山河图》卷三——结算篇
\a 推荐优先阅读卷零——总论，对系统全貌有大致了解后再阅读其他卷，其他卷无先后顺序。
第1章 序言
1.1 背景
1.2 专业名词
1.3 特别说明
第2章 支付发展史
2.1 第一方支付
2.2 第二方支付
2.3 第三方支付
2.4 第四方支付
第3章 三方支付概述
3.1 视角切换
3.2 运作模式
3.2.1 初始状态
3.2.2 用户充值
3.2.3 用户提现
3.2.4 用户转账
3.2.5 资金变动汇总
3.3 支付交互
3.4 领域划分
3.5 技术架构
第4章 参考文章
第5章 结束语
第1章 序言
1.1 背景
支付方式的发展历程是怎样的？第一方、二方、三方、四方支付是什么？三方支付系统的背后支撑体系是怎样的？一个完整的第三方支付系统由哪些部分组成？各个组成部分的作用原理是什么？
\a 我会尝试以图卷的形式来描绘我所见到的第三方支付系统，从宏观的视角来介绍整个体系，然后再以微观视角深入各个部分，了解其实现细节。
\a PS：为了尽可能简单明了地阐述整体逻辑，一些深入的业务和实现细节被选择性地省略了，但后续各个方向的文章会详细阐述每一个过程的具体实现方式。文章观点参考了现有文献以及个人理解，如有错误，敬请指正。

1.2 专业名词
专业名词	名词解释
支付工具	具有第三方支付能力的应用，如微信支付、支付宝都属于第三方支付工具。何为“第三方”在下文介绍，第三方支付工具后续简称为“支付工具”。
用户	在支付工具中注册并开通和使用支付功能的人，就是该支付工具的用户。
商户	接入支付工具，并对用户提供服务的商家。
现金账户	C（Cash）账户。持有人可自由操作其中资金的账户类型。用户只拥有现金账户，商户既具有现金账户，也具有交易账户。
交易账户	B（Business）账户。商户用于与用户交易的特殊账户。用户支付的交易款会进入商户B账户，该账户资金经过结算后进入商户C账户。
备付金	支付机构为办理客户委托的支付业务而实际收到的预收待付货币资金。可以简单理解为用户暂存在支付机构开具的银行账户中的资金。
支付	狭义的支付仅指用户向商户划转资金，广义的支付还包括充值、转账等功能。
付款	指资金从支付机构的备付金账户转出到目的银行账户。如用户将微信余额提现到自己的工行银行卡，此时资金从微信的工行备付金账户转账到用户的工行账户，这是付款的一种典型业务场景。
退款	指支付机构将用户支付的款项从商户账户退回到用户支付账户或银行卡。
结算	是支付机构将商户交易账户中的资金，按照合同约定的时间和费率，收取手续费后转入商户现金账户的过程。通常支付机构还会为商户提供自动提现到银行卡的附加功能。
资管	即资产管理。负责预防资金风险，及时准确的发现资金问题。具体包括会计核对、备付金管理、平台对账等。
1.3 特别说明
支付基础能力是由CDG的FIT线提供，公司主体是财付通支付科技有限公司，下文中的内容也是以财付通当前体系为参考。但为了便于大多数人理解，下文中将以“微信支付”来代指整个支付机构。

第2章 支付发展史
我们日常生活中使用的微信支付、支付宝都属于第三方支付应用，那么什么是第三方支付？为什么叫做第三方支付？第一方支付和第二方支付又是什么呢？还有第四方支付吗？
\a 我们不妨以支付历史发展进程来对它们进行一一阐述。

2.1 第一方支付
第一方支付如下图所示：
\a  
\a 第一方支付即现金支付，从最早出现货币的时候，我们就开始并长时间依赖于这种支付方式。随着商业的发展，大宗交易不再适合使用现金进行支付，第一方支付不再能满足需求。

2.2 第二方支付
第二方支付如下图所示：
\a  
\a 第二方支付是依托于银行的支付方式。买卖双方通过银行来进行资金的划转，避免了大额现金交易带来的安全、携带、保存、清点、验证等问题，使得大额交易变得快捷、方便、安全和简单。
\a 由于银行操作存在一定的成本和使用门槛，因此第二方支付逐渐从日常生活和小额市场的支付中淡化并退出，转而在一些巨额的交易和政策性的金融活动中发光发热。

2.3 第三方支付
第三方支付如下图所示：
\a  
\a 第三方支付是指具备一定实力和信誉保障，并获得国家颁发运营牌照的独立机构，采用和各大银行签约的方式，通过与银行相关接口对接而促成交易的网络支付模式。我们熟悉的微信支付和支付宝都属于第三方支付工具。
\a 第三方支付工具随着移动互联网的大范围普及而迅速占领日常生活中的各种交易场景，逐渐取代了大部分的中小额现金交易。
\a （PS：目前境内的第三方支付工具应国家要求已经不再直接与银行对接，而是通过银联或网联与各大银行对接。具体可参考文章：http://km.oa.com/group/626/articles/show/417754 ）

2.4 第四方支付
第四方支付实际上是支付服务集成商，它聚合了多个第三方支付、合作银行的渠道接口：
\a  
\a 第四方支付目前并未获得国家支付结算许可，交易资金不受银行监管，存在机构卷钱跑路的风险，用户资金安全不能得到保证。

第3章 三方支付概述
3.1 视角切换
以一个常见的菜市场买菜的场景为例，在用户视角，支付过程如下：
\a  

用户挑选好蔬菜后，打开微信支付，扫描卖家二维码，输入金额和密码完成支付，拿走货物，用户角度的支付过程到此结束。
\a 但从系统的角度来看，支付仅仅只是整个交易链路中的过程之一。在交易的事前事后还需要很多其他过程的协助。
\a 让我们跳出用户视角，思考一些深入的问题：
\a 1、 我们购买货物的微信余额是怎么来的？如果使用银行卡支付，那么钱是如何从银行卡转移到微信的？
\a 2、 当我们的银行卡急需资金，选择从微信提现到银行卡时，资金是如何转移的？
\a 3、 用户支付的钱是怎么给到商家的？微信支付有收取交易手续费吗？ 什么时候收的？
\a 4、 当我们对购买的货物不满意，想要退款时，资金是如何退回的？
\a 由此可见，想要真正了解支付，我们的关注点就不能只停留在用户的角度。

3.2 运作模式
支付机构本质上还是资金相关的操作，我们知道第三方支付涉及用户、银行和支付机构本身。下面我们将从资金的角度来介绍几种典型的支付业务，让大家对支付背后的资金流动有一个直观的了解。

3.2.1 初始状态
我们将以一个典型例子来说明，涉及对象的初始状态如下图所示：
\a  
\a 涉及的用户有两个，张三和李四，他们分别有自己的微信账户和银行账户，微信也在银行开具了自己的银行账户，称为备付金账户（备付金在1.2节介绍）。他们各自的余额如上图所示。

3.2.2 用户充值
现在假设张三想要通过自己的银行卡充值20元到微信余额，资金变动如下图所示：
\a  
\a 首先是张三的银行账户向微信备付金账户转账20元，成功后微信则给张三的微信余额加20元，充值完成。
\a PS：用户在微信中绑定了银行卡，因此不需要用户去银行转账，而是通过微信与银行间的接口来自动完成该笔资金的划转。

3.2.3 用户提现
假设李四想要将微信中余额提现10元到自己的银行卡，则资金变动如下：
\a  
\a 首先将李四的微信余额减去10元，然后调用银行接口，从微信备付金账户中转账10元到李四的银行卡中，提现过程结束。
\a PS：这里减去李四微信余额时并不是直接减掉，而是先冻结，等银行侧成功转账后再实际减去。冻结和解冻的细节和原因将在付款卷中详细介绍。

3.2.4 用户转账
假设张三要给李四转账20元，则资金变动如下图：
\a  
\a 此时，张三的微信余额先减20，然后李四的余额加20，转账完成。用户向商户支付的过程也是类似的，区别在于李四变成了商户，并且后续还有“结算”流程。
\a 想一想：如果张三余额不足怎么办？
\a 此时张三可以选择先充值，补齐微信余额；也可以在转账时直接选择银行卡转账，此时会增加与银行交互的步骤。具体细节将在支付卷中介绍。

3.2.5 资金变动汇总

\a 从上面的表格我们注意到：备付金账户和微信账户的变动总是相等的。
\a 如充值时，微信余额增加，则备付金账户也会增加相同的金额；提现时，微信余额减少，则备付金账户的余额也会减少相同金额。
\a 因此，我们可以认为所有微信余额是所有备付金银行账户余额的映射。我们称微信余额为系统资金，银行余额为物理资金。如果物理资金小于系统资金，则说明物理资金被挪用，可能会导致用户无法提现。国家会监管持牌支付机构的备付金使用情况，避免这样的情况出现。

3.3 支付交互
上一节主要介绍了用户的一些业务场景，如提现、转账。那么关于商户的业务场景又有哪些呢？下图是用户与商户之间的重要业务交互图：
\a  
\a 用户和商户也都拥有自己的银行账户和微信支付账户。微信支付作为中间桥梁，将银行、用户、商户连接起来，共同构成了整个交易网络。
\a 从交互图中可以看出，支付系统具有很多重要的功能：
\a 1、 充值。用户将银行卡中的资金转移微信支付中，成为微信余额的过程。
\a 2、 提现。用户或商户将微信余额转移到银行卡的过程。
\a 3、 支付。这里特指用户将资金从自己的现金账户划转到商户的交易账户过程。
\a 4、 退款。支付的逆向过程，将资金从商户账户退回到用户账户。
\a 5、 结算。用户支付给商户的资金，在收取手续费后，划转到商户的现金账户的过程。
\a 上述功能中，有的只涉及用户，如充值和提现；有的同时涉及用户和商户，如支付、退款；而有的只涉及商户，如结算。

3.4 领域划分
业务功能多种多样，为了进一步简化模型，我们需要对业务领域进行抽象。抽象后剥离出了两个大的方向：基础支付和清算。清算又分为：付款、退款、结算、资管。
\a  

下面对这些领域进行简单说明：

基础支付：负责支付业务、交易平台的建设，提供支付、转账等能力。
付款：负责将用户的现金账户资金通过银行接口转到指定的银行卡，如提现、信用卡还款等业务均依赖于付款能力。
退款：负责将用户支付的资金从商户账户退回用户账户或用户银行卡。
结算：负责按照合同约定的规则，将商户交易账户的资金划转到商户现金账户，并收取交易手续费。
资管：负责资金管理和内外资金核对，保障系统资金安全。
\a 各个领域提供基础能力，并服务各种各样的业务场景。有的业务场景需要多种领域能力合作完成，如结算业务需要依赖于付款的提现能力。
3.5 技术架构
以境外的wechat pay为例，整体的技术架构如下图所示：
\a  
\a 最底层的核心记账平台负责所有账户的构建，并提供通用的记账能力。
\a 中层的基础交易平台，保存了用户资料和各种业务单据，并提供转账、提现等各种基础能力，供业务侧使用。
\a 上层的领域业务通过组合、包装基础交易平台的能力，来完成业务功能的构建。
\a 我们在上一节划分的五个领域，有的作为支撑能力为基础交易平台服务，如付款；有的作为领域业务服务用户，如支付、退款、结算；有的为系统本身的稳定和安全保驾护航，如资管。

第4章 参考文章
《一文看懂什么叫第一方、第二方、第三方、第四方支付？》http://m.498.net/hyxw/article-930.html
《多币种交易系统》http://km.oa.com/group/cdgpd/articles/show/427726
《境外付款系统介绍.pptx》
《资金管理业务介绍.ppt》
《付款业务简介.ppt》
第5章 结束语
在上文的介绍中，我们说明了几个重要的问题：
\a 1、 什么是第三方支付
\a 2、 第三方支付业务背后的资金是怎么流动的。
\a 3、 第三方支付系统包含哪些主要领域。
\a 4、 第三方支付系统的技术组织结构实例。
\a 在本文中，我们从一个全局的角度大致说明了一个支付系统的全貌，这对后续深入每一个领域非常有帮助。这使得我们在后续文章分析说明各个领域的实现原理和细节时，可以随时跳出，从全局的视角来审视该业务的能力和边界。